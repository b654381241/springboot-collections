分布式事务专题
===

1、基础概念

1.1 什么事事务
	
1.2本地事务

		在计算机系统中，更多的是通过关系型数据来控制事务，这是利用数据库本身的事务特性来控制实现。因此也叫数据库事务。由于应用主要靠关系型数据库来控制事务，二数据库通常和应用在同一个服务器，所以也叫本地数据库事务。

	回顾一下数据库事务的四大特性（ACID）

	A（Atomic）：原子性，构建事务的所有操作，要么全成功，要么全部失败，不会出现部分成功和部分失败。

	C(Consistency):一致性，在事务执行前后，数据库的一致性约束没有破坏。

	I(Isolation):隔离性：数据库中的事务一般都是并发的，隔离性是指并发的两个事务的执行互不干扰，一个事务不能看到其他事务运行过程中的中间状态，通过配置事务的隔离级别可以避免脏读、重复读、幻读等问题。

	D(Durablity):持久性，事务完成之后，该事务对数据的更改会被持久化到数据库，不会出现被回滚。


1.3 分布式事务(基于网络通信)
	
	分布式系统会把一个系统拆分成可独立部署的的多个服务，因此需要与服务之间远程协作才能完成才能完成操作，这种分布式系统环境下由于不同的服务之间通过网络远程协作王成事务称之为分布式事务。

1.4 分布式事务的产生的场景

	1. 典型的场景就是微服务架构
	微服务之间通过远程调用完成事务操作（跨jvm进程操作产生分布式事务）

	2. 单体系统访问多个数据库实例（实例：可以理解为mysql的进程）
	单体系统需要访问多个数据库实例时就会产生分布式事务，简言之就是跨数据库实例产生的分布式事务。

	3. 多服务访问同一个数据库实例
	比如：订单服务和库存服务即使访问同一个数据库也会产生分布式事务，原因就是跨jvm进程，两个微服务持有了不同的数据链接进行数据操作，此时产生分布式事务。


上述产生的问题：不能通过本地数据库的进行事务来控制。


2. 分布式事务理论基础
	
	2.1 CAP理论
	   2.1.1 理解 CAP
			
		CAP是Consistency 、Availability、Partition tolerance三个单词的缩写，分别表示一致性、可用性、分区容错性。

		一致性：是指写操作后的读操作可以读到最新的数据状态，当数据分布在多个节点上，从任意节点读取到数据都是最新的状态。
		如何实现一致性：
		1. 写入主数据库后要讲数据同步到从数据库。
		2. 写入主数据库后，在向从数据库同步期间要将从数据库锁定，待同步完成后再释放锁，以免在新数据写入成功后向从数据库查询到旧的数据。
		
		分布式系统一致性的特点：
		1. 由于存在数据同步过程，写操作的响应会有一定延迟。
		2. 为了保证数据一致性会对资源暂时锁定，待数据同步完成释放锁定资源
		3. 如果请求数据同步失败的节点则会返回错误信息，一定不会返回旧数据。

		可用性：是指任何事物操作都可以得到响应结果，且不会出现响应报错，或者响应超时。
		1. 从数据库接受到数据查询请求的响应，则立即能够响应数据 查询结果。
		2. 从数据库不允许出现相应超时或者响应错误。
	
		如何实现可用性：
		1. 写入主数据库后要将数据同步到从数据库。
		2. 由于要保证数据库的可用性，不可将从数据库中的资源进行锁定。
		3. 即使的数据还没有同步过来，从数据库也要返回查询结果，哪怕是旧数据，如果旧数据也没有则可以按照约定返回一个默认信息，但不能返回错误或者响应超时。

		分布式系统可用性的特点：
		1. 所有请求都有响应，且不会出现响应错误和超时。

		分区容错性：
		
		通常分布式系统的各个节点部署在不同的子网，这就是网络分区，不可避免的会出现由于网络原因而导致节点之间通信失败，此时仍可对外界提供服务，这叫分区容错性。

		1. 主数据库向从数据库同步数据失败不影响读写操作。
		2. 其一个节点挂点不影响另一个节点对外提供服务。

		如何实现分区容错性
		1. 尽量使用异步取代同步操作，例如使用异步方式将主数据库同步到从数据库，这样节点之间能有效的实现松耦合。
		2. 添加从数据库节点，其中一个服务挂掉其他从节点可继续提供服务。

		分布式分区容错性的特点：
		1.分区容错性是分布式系统的基本能力。

2.1.2 CAP组合方式
		
		在所有分布式事务场景中不会同时具备CAP三个特性，因为在具备了P的前提下C和A是不能共存的。
		如果要实现C则必须保证数据的一致性，在数据同步的时候为了防止向从数据库表查询不一致的，则需要对从数据进行锁定，待同步完成后解锁，如果同步失败从数据库要返回错误信息或者超时信息。
		如果要实现A则必须要保证数据的可用性，不管任何时候都可以向从数据库查询数据。则不会出现响应超时或者错误信息。所以通过分析发现满足p的前提下，C和A存在矛盾。

2.1.3 CAP 有哪些组合方式

	1. AP
	放弃一致性，追求分区容错性和可用性，这是很多分布式系统设计时的选择。
	通常实现AP都会保证最终的一致性，后面的BASE理论就是根据AP来扩展的，一些业务场景：订单退款，今日退单成功，退款明天账户到账，只要用户可以接受在一定时间内到账即可。

	2. CP 
	放弃可用性，追求数据的一致性和分区容错性，我们的zookeeper其实就是追求的强一致性，又比如跨行转账，一次转账请求，要等待双方银行系统都完成这个事务才算完成。
	
	3. CA
	放弃分区容错性，即不进行分区，不考虑由于网络不通或者节点挂掉的问题，则可以实现一致性和可用性，那么系统将不是一个标准的分布式系统，我们常用的关系型数据库就满足的CA。

2.2 BASE理论

1. 理解强一致性和最终一致性
	
		CAP理论告诉我们一个分布式系统最多只能同时满足一致性、可用性和分区容错性这三项中的两项。其中AP在实际生活中应用较多，AP即舍弃一致性，保证可用性和分区容错性。但是实际生产中很多场景都要实现一致性，比如主数据库向从数据库同步数据，即使不要一致性，但是最终也要成功将数据同步到从数据库中来保证数据一致，这种一致性和CAP中的一致性不同，CAP中的一致性要求任何时间查询从库的每个节点数据都是最新的且一致的，它强调的就是强一致性。但是最终一致性，允许在一段时间内每个节点的数据不一致，但是经过一段时间后，每个节点的数据必须一致，他强调的最终一致性。

2. BASE理论的介绍
	
		BASE是Basicall Avilable(基本可用)、Soft state(软转态)和Eventually consistent(最终一致性)三个短语的缩写。BASE理论是对CAP中的AP的一个补充扩展通过牺牲强一致性来获得可用性，当出现故障部分不可用但要保证核心功能的可用，允许数据在一段时间内不一致，但最终的状态达到一致状态，满足BASE理论的事务我们称之为柔性事务。
	
		1. 基本可用：分布式系统出现故障时，允许损失部分可用功能，保证核心功能的可用。如电商网站交易付款出现问题，商品依然可以正常访问。
		2. 软状态： 由于不要求强一致性，所以BASE允许系统中存在中间状态，这个状态不影响可用性。如订单的“支付中”，“数据同步中”等状态，待数据最终一致后状态改为“成功”状态。
		3. 最终一致性：是指经过一段时间，所有的节点数据都会达到一致。


3 分布式事务解决方案之---2PC 协议( 两阶段提交 )

 3.1 什么事 2PC
	
	2PC即两阶段提交协议，是将整个事务流程分为两个阶段，准备阶段（Prepare phase）、提交阶段（Commit phase）,2是指两个阶段，P是指准备阶段，C是指提交阶段。

	过程(oracle 和mysql都支持两阶段提交)：
	1. 准备阶段：事务管理器给每个参与者发送Prepare消息，每个数据库参与者在本地执行事务，并写入本地的Undo/Redo日志，此时事务没有提交。
	（ Undo日志是记录修改前的数据，用于数据库的回滚，Redo日志记录修改后的数据，用于提交事务后写入数据文件 ）
	2. 提交阶段：如果事务管理器收到参与者的执行失败或者超时消息时，直接每个参与者发送回滚（Rollback）消息，否则，发送提交（Commit）消息；参与者根据事务管理器的指令执行提交或者回滚操作。并释放事务管理过程中使用的锁资源。注意：必须在最后阶段释放锁资源。

3.2 解决方案-- XA方案

	2PC的传统方案是在数据库层面实现的，如Oracle、Mysql都支持2PC协议，为了统一标准减少行业内不必要的对接成本，需要制定标准化的处理模型以及接口标准，国际开发组织定义了分布式事务处理模型 DTP

	执行流程如下（设定  A进行减，B进行加）：
	1. AP(应用程序)持有数据库A和数据库B两个数据源。
	2. AP通过TM通知数据库A的RM（参与者即 资源管理器）进行减操作，同时通知数据库B的RM进行加操作，此时两个RM都没有提交事务，并且两个错作的资源资源都被锁定。
	3. TM(全局事务管理器)收到执行回复，只要有一方失败则分别向其他的RM发起回滚的操作。
	4. TM收到执行回复，全部成功，此时向所有的RM发起提交事务，提交完毕，资源锁释放。

		注：DTP模型的角色介绍：
			1. AP(Application Program): 即应用程序，可以理解为使用DTP分布式事务的程序。
			2. RM(Resource Manger ): 即资源管理器，可以理解为事务的参与者，一般情况下是指数据实例。通过资源管理器对该数据库进行控制，资源管理器控制着分支事务。
			3. TM(Transaction Manager): 事务管理器，负责协调和管理事务，事务管理器控制着全局事务，管理事务声明周期，并协调各个RM,全局事务是指分布式事务处理环境中，需要操作多个数据库共同完成一个工作，这个工作即是一个全局事务。
			4. DTP 模型定义TM和RM之间通信的接口规范叫XA,简单理解为数据库提供的2PC接口协议。基于数据的XA协议来实现2PC又称XA方案。
			5. 以上三个角色之间的交互方式如下：
	1）TM向AP提供应用程序编程接口，AP通过TM提交或回滚事务。
	2）TM交易通过XA接口来通知RM数据库事务的开始、结束以及替提交、回滚。
	

总结：
	
	整个2PC的事务涉及到单个角色AP、RM、TM。AP指的是使用2PC分布事务的应用程序；RM指的是资源管理器，它控制着分支事务；TM指的是事务管理器，它控制着整个全局事务。

	1）：在准备阶段，RM执行实际的业务操作，但不提交事务，资源锁定；
	2）：在提交阶段，TM会接收RM在准备阶段的执行回复明知要有任一个RM执行失败，TM都会进行回滚操作，否则，TM会通知各个RM提交事务，提交阶段结束后，资源所释放。

	XA方案的问题：
	1. 需要本地数据库支持XA协议。
	2. 资源锁需要等到两个阶段结束后才能释放，性能较差。
